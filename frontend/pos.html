<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#e65100">
<title>POS Pupuser√≠a - Sistema de Pedidos</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="css/styles-responsive.css">
<link rel="stylesheet" href="css/pos.css">
</head>
<body>
<!-- Navbar Principal -->
<nav class="navbar navbar-pos navbar-dark">
<div class="container-fluid">
<span class="navbar-brand mb-0 h1">
<i class="bi bi-shop"></i> POS Pupuser√≠a
</span>
<div class="d-flex align-items-center gap-2">
<span id="current-role" class="badge bg-warning text-dark d-none" style="font-size: 0.85rem;"></span>
<span class="text-white d-none d-md-inline" id="usuario-info">
<i class="bi bi-person-circle"></i>
<span id="usuario-nombre-display"></span>
</span>
<span id="current-time" class="text-white-50 d-none d-lg-inline small"></span>
<button class="btn btn-outline-light btn-sm" onclick="logout()">
<i class="bi bi-box-arrow-right"></i>
</button>
</div>
</div>
</nav>
<!-- Barra Manager (visible solo para managers) -->
<div id="manager-toolbar" class="manager-toolbar d-none">
<div class="d-flex align-items-center gap-2">
<span class="role-indicator">
<i class="bi bi-shield-check"></i> Manager
</span>
<span id="viewing-as-role" class="badge bg-light text-dark"></span>
</div>
<div class="d-flex align-items-center gap-2">
<button class="btn btn-warning btn-sm" onclick="mostrarSelectorRol()">
<i class="bi bi-arrow-repeat"></i> <span class="d-none d-md-inline">Cambiar Rol</span>
</button>
</div>
</div>
<div class="container-fluid mt-4">
<!-- Panel Manager (incluye selector de roles) -->
<div id="panel-manager" class="work-panel">
<div class="row">
<div class="col-12">
<!-- Encabezado del panel manager -->
<div class="card mb-4" style="background: linear-gradient(135deg, #6f42c1, #9c27b0); border: none;">
<div class="card-body text-white">
<div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
<div>
<h4 class="mb-1"><i class="bi bi-shield-check"></i> Panel de Manager</h4>
<p class="mb-0 opacity-75">Selecciona un rol para operar o accede a administraci√≥n</p>
</div>
<div class="d-flex gap-2 flex-wrap">
<a href="index.html" class="btn btn-outline-light btn-sm">
<i class="bi bi-receipt"></i> Facturaci√≥n
</a>
<a href="admin.html" class="btn btn-light btn-sm">
<i class="bi bi-gear"></i> Administraci√≥n
</a>
</div>
</div>
</div>
</div>

<!-- Selector de roles integrado -->
<div class="role-selector mx-auto" style="max-width: 1000px;">
<h5 class="text-center mb-3"><i class="bi bi-person-workspace"></i> Operar como:</h5>
<div class="row g-3">
<div class="col-6 col-md-4">
<div class="card role-card h-100 text-center p-3" onclick="seleccionarRol('mesero')">
<div class="role-icon role-mesero">
<i class="bi bi-person-badge"></i>
</div>
<h5>Mesero</h5>
<p class="text-muted small mb-0">Tomar pedidos y servir mesas</p>
</div>
</div>
<div class="col-6 col-md-4">
<div class="card role-card h-100 text-center p-3" onclick="seleccionarRol('cajero')">
<div class="role-icon role-cajero">
<i class="bi bi-cash-register"></i>
</div>
<h5>Cajero</h5>
<p class="text-muted small mb-0">Cobros, pagos y facturaci√≥n</p>
</div>
</div>
<div class="col-6 col-md-4">
<div class="card role-card h-100 text-center p-3" onclick="seleccionarRol('cocinero')">
<div class="role-icon role-cocinero">
<i class="bi bi-fire"></i>
</div>
<h5>Cocina</h5>
<p class="text-muted small mb-0">Preparar y despachar pedidos</p>
</div>
</div>
</div>
</div>

<!-- Resumen r√°pido del d√≠a -->
<div class="row mt-4" id="manager-stats">
<div class="col-6 col-md-3">
<div class="card text-center h-100">
<div class="card-body">
<i class="bi bi-receipt text-primary fs-2"></i>
<h3 class="mb-0" id="manager-stat-pedidos">-</h3>
<small class="text-muted">Pedidos hoy</small>
</div>
</div>
</div>
<div class="col-6 col-md-3">
<div class="card text-center h-100">
<div class="card-body">
<i class="bi bi-cash-stack text-success fs-2"></i>
<h3 class="mb-0" id="manager-stat-ventas">-</h3>
<small class="text-muted">Ventas hoy</small>
</div>
</div>
</div>
<div class="col-6 col-md-3">
<div class="card text-center h-100">
<div class="card-body">
<i class="bi bi-hourglass-split text-warning fs-2"></i>
<h3 class="mb-0" id="manager-stat-pendientes">-</h3>
<small class="text-muted">Pendientes</small>
</div>
</div>
</div>
<div class="col-6 col-md-3">
<div class="card text-center h-100">
<div class="card-body">
<i class="bi bi-grid-3x3 text-info fs-2"></i>
<h3 class="mb-0" id="manager-stat-mesas">-</h3>
<small class="text-muted">Mesas ocupadas</small>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- Selector de Rol antiguo (oculto, se mantiene por compatibilidad) -->
<div id="role-selector" class="role-selector mx-auto" style="max-width: 1000px; display: none;"></div>
<!-- Panel Mesero -->
<div id="panel-mesero" class="work-panel">
<div class="row">
<!-- Mesas y Men√∫ -->
<div class="col-lg-8">
<ul class="nav nav-tabs mb-3" id="meseroTabs">
<li class="nav-item">
<button class="nav-link active" data-bs-toggle="tab" data-bs-target="#mesas-tab">
<i class="bi bi-grid-3x3"></i> Mesas
</button>
</li>
<li class="nav-item">
<button class="nav-link" data-bs-toggle="tab" data-bs-target="#menu-tab">
<i class="bi bi-menu-button-wide"></i> Men√∫
</button>
</li>
<li class="nav-item position-relative">
<button class="nav-link" data-bs-toggle="tab" data-bs-target="#servir-tab">
<i class="bi bi-bell"></i> Por Servir
<span id="badge-servir" class="notification-badge d-none">0</span>
</button>
</li>
</ul>
<div class="tab-content">
<!-- Tab Mesas -->
<div class="tab-pane fade show active" id="mesas-tab">
<div class="mesa-grid" id="mesas-container"></div>
</div>
<!-- Tab Men√∫ -->
<div class="tab-pane fade" id="menu-tab">
<div class="categoria-tabs" id="categorias-container"></div>
<div class="menu-grid" id="productos-container"></div>
</div>
<!-- Tab Por Servir -->
<div class="tab-pane fade" id="servir-tab">
<div id="pedidos-servir-container"></div>
</div>
</div>
</div>
<!-- Carrito -->
<div class="col-lg-4">
<div class="cart-panel">
<div class="p-3 border-bottom">
<h5 class="mb-0">
<i class="bi bi-cart3"></i> Pedido Actual
<span id="mesa-seleccionada" class="badge bg-primary ms-2"></span>
</h5>
</div>
<div class="cart-items" id="cart-items">
<p class="text-muted text-center">Selecciona productos del men√∫</p>
</div>
<div class="cart-total">
<div class="d-flex justify-content-between mb-2">
<span>Subtotal:</span>
<span id="cart-subtotal">$0.00</span>
</div>
<div class="d-flex justify-content-between mb-2">
<span>IVA (13%):</span>
<span id="cart-iva">$0.00</span>
</div>
<div class="d-flex justify-content-between mb-3">
<strong>Total:</strong>
<strong id="cart-total">$0.00</strong>
</div>
<div class="mb-2">
<select class="form-select form-select-sm" id="tipo-pago" onchange="if(typeof toggleOpcionesPago === 'function'){ toggleOpcionesPago(); }">
<option value="anticipado">Pago anticipado (para llevar)</option>
<option value="al_final">Pago al final (en mesa)</option>
</select>
</div>
<div id="opciones-para-llevar" class="mb-2">
<input type="text" class="form-control form-control-sm" id="cliente-nombre-pedido" placeholder="Nombre del cliente">
</div>
<button class="btn btn-primary w-100" onclick="enviarPedido()" id="btn-enviar-pedido" disabled>
<i class="bi bi-send"></i> Enviar Pedido
</button>
</div>
</div>
</div>
</div>
</div>
<!-- Panel Cajero -->
<div id="panel-cajero" class="work-panel">
<ul class="nav nav-tabs mb-3" id="cajeroTabs">
<li class="nav-item">
<button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cajero-cobros-tab">
<i class="bi bi-cash-stack"></i> Cobros Pendientes
</button>
</li>
<li class="nav-item">
<button class="nav-link" data-bs-toggle="tab" data-bs-target="#cajero-pedido-tab">
<i class="bi bi-bag-plus"></i> Nuevo Pedido
</button>
</li>
<li class="nav-item">
<button class="nav-link" data-bs-toggle="tab" data-bs-target="#cajero-creditos-tab">
<i class="bi bi-credit-card-2-front"></i> Gesti√≥n Cr√©ditos
</button>
</li>
<li class="nav-item">
<button class="nav-link" data-bs-toggle="tab" data-bs-target="#cajero-reportes-tab">
<i class="bi bi-graph-up"></i> Reportes R√°pidos
</button>
</li>
</ul>
<div class="tab-content">
<!-- Tab Cobros Pendientes -->
<div class="tab-pane fade show active" id="cajero-cobros-tab">
<div class="row">
<div class="col-lg-8">
<h5 class="mb-3"><i class="bi bi-hourglass-split"></i> Pedidos Pendientes de Pago</h5>
<div id="pedidos-cajero-container"></div>
</div>
<div class="col-lg-4">
<div class="card">
<div class="card-header bg-success text-white">
<h5 class="mb-0"><i class="bi bi-graph-up"></i> Resumen del D√≠a</h5>
</div>
<div class="card-body">
<div class="d-flex justify-content-between mb-2">
<span>Pedidos cerrados:</span>
<strong id="stat-pedidos">0</strong>
</div>
<div class="d-flex justify-content-between mb-2">
<span>Ventas totales:</span>
<strong id="stat-ventas">$0.00</strong>
</div>
<hr>
<h6>Top Productos</h6>
<ul id="stat-top-productos" class="list-unstyled small"></ul>
</div>
</div>
</div>
</div>
</div>
<!-- Tab Nuevo Pedido (Para Llevar) -->
<div class="tab-pane fade" id="cajero-pedido-tab">
<div class="row">
<div class="col-lg-8">
<div class="alert alert-info mb-3">
<i class="bi bi-info-circle"></i> <strong>Pedido Para Llevar:</strong> Crea pedidos directamente y cobra al momento.
</div>
<div class="categoria-tabs" id="categorias-container-cajero"></div>
<div class="menu-grid" id="productos-container-cajero"></div>
</div>
<div class="col-lg-4">
<div class="cart-panel" id="cart-panel-cajero">
<div class="p-3 border-bottom">
<h5 class="mb-0">
<i class="bi bi-bag"></i> Pedido Para Llevar
</h5>
</div>
<div class="cart-items" id="cart-items-cajero">
<p class="text-muted text-center">Selecciona productos del men√∫</p>
</div>
<div class="cart-total">
<div class="d-flex justify-content-between mb-2">
<span>Subtotal:</span>
<span id="cart-subtotal-cajero">$0.00</span>
</div>
<div class="d-flex justify-content-between mb-2">
<span>IVA (13%):</span>
<span id="cart-iva-cajero">$0.00</span>
</div>
<div class="d-flex justify-content-between mb-3">
<strong>Total:</strong>
<strong id="cart-total-cajero">$0.00</strong>
</div>
<div class="mb-2">
<input type="text" class="form-control" id="cliente-nombre-cajero" placeholder="Nombre del cliente (requerido)">
</div>
<button class="btn btn-success w-100" onclick="crearPedidoCajero()" id="btn-crear-pedido-cajero" disabled>
<i class="bi bi-cash-coin"></i> Crear y Cobrar
</button>
</div>
</div>
</div>
</div>
</div>
<!-- Tab Gesti√≥n de Cr√©ditos -->
<div class="tab-pane fade" id="cajero-creditos-tab">
<div class="row">
<div class="col-lg-6">
<div class="card mb-3">
<div class="card-header bg-warning">
<h5 class="mb-0"><i class="bi bi-person-plus"></i> Otorgar/Modificar Cr√©dito</h5>
</div>
<div class="card-body">
<div class="mb-3">
<label class="form-label">Buscar Cliente</label>
<input type="text" class="form-control" id="buscar-cliente-credito"
placeholder="Nombre, DUI o NIT..." onkeyup="buscarClienteCredito(this.value)">
<div id="resultados-cliente-credito" class="list-group mt-2"></div>
</div>
<div id="form-credito-cliente" style="display:none;">
<hr>
<h6 id="nombre-cliente-credito"></h6>
<input type="hidden" id="id-cliente-credito">
<div class="row mb-3">
<div class="col-6">
<label class="form-label">Cr√©dito Autorizado ($)</label>
<input type="number" class="form-control" id="monto-credito-autorizado" min="0" step="0.01">
</div>
<div class="col-6">
<label class="form-label">D√≠as de Cr√©dito</label>
<input type="number" class="form-control" id="dias-credito-cliente" min="0">
</div>
</div>
<div class="alert alert-secondary mb-3">
<div class="d-flex justify-content-between">
<span>Cr√©dito Utilizado:</span>
<strong id="credito-utilizado-info">$0.00</strong>
</div>
<div class="d-flex justify-content-between">
<span>Cr√©dito Disponible:</span>
<strong id="credito-disponible-info">$0.00</strong>
</div>
</div>
<button class="btn btn-warning w-100" onclick="guardarCreditoCliente()">
<i class="bi bi-save"></i> Guardar Cr√©dito
</button>
</div>
</div>
</div>
</div>
<div class="col-lg-6">
<div class="card">
<div class="card-header bg-info text-white">
<h5 class="mb-0"><i class="bi bi-list-check"></i> Ventas a Cr√©dito Pendientes</h5>
</div>
<div class="card-body" style="max-height: 400px; overflow-y: auto;">
<div id="lista-creditos-pendientes">
<p class="text-muted text-center">Cargando...</p>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Tab Reportes R√°pidos -->
<div class="tab-pane fade" id="cajero-reportes-tab">
<!-- Selector de per√≠odo r√°pido -->
<div class="row mb-3">
<div class="col-md-12">
<div class="btn-group w-100" role="group">
<input type="radio" class="btn-check" name="periodoReportes" id="periodo-hoy" value="hoy" checked onchange="cambiarPeriodoReportes('hoy')">
<label class="btn btn-outline-primary" for="periodo-hoy">
<i class="bi bi-calendar-day"></i> Hoy
</label>
<input type="radio" class="btn-check" name="periodoReportes" id="periodo-7d" value="7d" onchange="cambiarPeriodoReportes('7d')">
<label class="btn btn-outline-primary" for="periodo-7d">
<i class="bi bi-calendar-week"></i> √öltimos 7 d√≠as
</label>
<input type="radio" class="btn-check" name="periodoReportes" id="periodo-30d" value="30d" onchange="cambiarPeriodoReportes('30d')">
<label class="btn btn-outline-primary" for="periodo-30d">
<i class="bi bi-calendar-month"></i> √öltimo mes
</label>
</div>
</div>
</div>
<!-- Tarjetas de M√©tricas -->
<div class="row" id="metricas-reportes">
<div class="col-md-3 mb-3">
<div class="card">
<div class="card-body">
<h6 class="card-title text-muted">Total Vendido</h6>
<h3 class="mb-0" id="metrica-total-ventas">$0.00</h3>
<small id="metrica-variacion-ventas" class="text-success"></small>
</div>
</div>
</div>
<div class="col-md-3 mb-3">
<div class="card">
<div class="card-body">
<h6 class="card-title text-muted">Total Pedidos</h6>
<h3 class="mb-0" id="metrica-total-pedidos">0</h3>
<small id="metrica-variacion-pedidos" class="text-success"></small>
</div>
</div>
</div>
<div class="col-md-3 mb-3">
<div class="card">
<div class="card-body">
<h6 class="card-title text-muted">Ticket Promedio</h6>
<h3 class="mb-0" id="metrica-ticket-promedio">$0.00</h3>
<small id="metrica-variacion-promedio" class="text-success"></small>
</div>
</div>
</div>
<div class="col-md-3 mb-3">
<div class="card">
<div class="card-body">
<h6 class="card-title text-muted">Efectivo vs Cr√©dito</h6>
<div class="d-flex justify-content-between">
<small><strong>Efectivo:</strong> <span id="metrica-efectivo">$0.00</span></small>
<small><strong>Cr√©dito:</strong> <span id="metrica-credito">$0.00</span></small>
</div>
</div>
</div>
</div>
</div>
<!-- Top Productos del per√≠odo -->
<div class="row">
<div class="col-md-6">
<div class="card">
<div class="card-header">
<h6 class="mb-0"><i class="bi bi-bar-chart"></i> Top Productos</h6>
</div>
<div class="card-body" style="max-height: 300px; overflow-y: auto;">
<div id="tabla-top-productos">
<p class="text-muted text-center">Cargando...</p>
</div>
</div>
</div>
</div>
<!-- Desglose por Categor√≠a -->
<div class="col-md-6">
<div class="card">
<div class="card-header">
<h6 class="mb-0"><i class="bi bi-tag"></i> Ventas por Categor√≠a</h6>
</div>
<div class="card-body" style="max-height: 300px; overflow-y: auto;">
<div id="tabla-categorias">
<p class="text-muted text-center">Cargando...</p>
</div>
</div>
</div>
</div>
</div>
<!-- Bot√≥n para acceder a reportes detallados (solo para managers) -->
<div class="row mt-3" id="boton-reportes-detallados" style="display: none;">
<div class="col-md-12">
<a href="reportes.html" class="btn btn-primary w-100" target="_blank">
<i class="bi bi-file-earmark-text"></i> Ver Reportes Detallados
</a>
</div>
</div>
</div>
</div>
</div>
<!-- Panel Cocina -->
<div id="panel-cocina" class="work-panel">
<h4 class="mb-3"><i class="bi bi-fire"></i> Pedidos en Cola</h4>
<div class="row" id="pedidos-cocina-container"></div>
</div>

</div>
<!-- Modal Confirmar Pago -->
<div class="modal fade" id="modalPago" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header bg-success text-white">
<h5 class="modal-title"><i class="bi bi-cash"></i> Confirmar Pago</h5>
<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<!-- Resumen del Pedido -->
<div id="detalle-pago-items" class="mb-3"></div>

<!-- Totales -->
<div class="card mb-3">
<div class="card-body py-2">
<div class="d-flex justify-content-between">
<span>Subtotal:</span>
<strong id="pago-subtotal">$0.00</strong>
</div>
<div id="pago-iva-row" class="d-flex justify-content-between text-info" style="display:none !important;">
<span>IVA (13%):</span>
<strong id="pago-iva">$0.00</strong>
</div>
<hr class="my-2">
<div class="d-flex justify-content-between fs-5">
<strong>Total a pagar:</strong>
<strong class="text-success" id="pago-total">$0.00</strong>
</div>
</div>
</div>

<!-- Tipo de Comprobante -->
<div class="mb-3">
<div class="form-check form-check-inline">
<input class="form-check-input" type="radio" name="tipoComprobante" id="tipo-ticket" value="ticket" checked onchange="onTipoComprobanteChange()">
<label class="form-check-label" for="tipo-ticket">
<i class="bi bi-receipt"></i> Ticket (sin IVA)
</label>
</div>
<div class="form-check form-check-inline">
<input class="form-check-input" type="radio" name="tipoComprobante" id="tipo-factura" value="factura" onchange="onTipoComprobanteChange()">
<label class="form-check-label" for="tipo-factura">
<i class="bi bi-file-earmark-text"></i> Cr√©dito Fiscal (con IVA)
</label>
</div>
</div>

<!-- Datos del cliente (solo para cr√©dito fiscal) -->
<div id="datos-cliente-container" class="card mb-3" style="display:none;">
<div class="card-body py-2">
<h6 class="mb-2"><i class="bi bi-person"></i> Datos para Cr√©dito Fiscal</h6>
<div class="row g-2">
<div class="col-12">
<input type="text" class="form-control form-control-sm" id="cliente-nombre" placeholder="Nombre / Raz√≥n Social *" required>
</div>
<div class="col-6">
<select class="form-select form-select-sm" id="cliente-tipo-doc">
<option value="36">NIT</option>
<option value="13">DUI</option>
</select>
</div>
<div class="col-6">
<input type="text" class="form-control form-control-sm" id="cliente-num-doc" placeholder="N√∫mero *" required>
</div>
<div class="col-12">
<input type="text" class="form-control form-control-sm" id="cliente-direccion" placeholder="Direcci√≥n *" required>
</div>
<div class="col-6">
<input type="text" class="form-control form-control-sm" id="cliente-nrc" placeholder="NRC (opcional)">
</div>
<div class="col-6">
<input type="tel" class="form-control form-control-sm" id="cliente-telefono" placeholder="Tel√©fono">
</div>
</div>
<input type="hidden" id="cliente-id-factura">
<input type="hidden" id="cliente-correo">
</div>
</div>

<!-- M√©todo de Pago -->
<div class="mb-3">
<label class="form-label mb-2"><i class="bi bi-wallet2"></i> M√©todo de Pago</label>
<div class="btn-group w-100" role="group">
<input type="radio" class="btn-check" name="metodoPago" id="metodo-efectivo" value="efectivo" checked onchange="onMetodoPagoChange()">
<label class="btn btn-outline-success" for="metodo-efectivo">
<i class="bi bi-cash-stack"></i> Efectivo
</label>
<input type="radio" class="btn-check" name="metodoPago" id="metodo-credito" value="credito" onchange="onMetodoPagoChange()">
<label class="btn btn-outline-warning" for="metodo-credito">
<i class="bi bi-credit-card-2-front"></i> Cr√©dito Cliente
</label>
</div>
</div>

<!-- Secci√≥n Cr√©dito Cliente (solo si m√©todo es cr√©dito) -->
<div id="seccion-credito-cliente" class="card mb-3 border-warning" style="display:none;">
<div class="card-body py-2">
<label class="form-label mb-2"><i class="bi bi-person-check"></i> Buscar Cliente con Cr√©dito</label>
<input type="text" class="form-control form-control-sm mb-2" id="buscar-cliente-pago-credito"
       placeholder="Buscar por nombre, DUI o NIT..." onkeyup="buscarClientePagoCredito(this.value)">
<div id="resultados-cliente-pago-credito" class="list-group mb-2" style="max-height:150px;overflow-y:auto;"></div>
<input type="hidden" id="cliente-pago-credito-id">
<!-- Info del cliente seleccionado -->
<div id="info-cliente-credito-pago" style="display:none;">
<div class="alert alert-info py-2 mb-0">
<div class="d-flex justify-content-between">
<span><i class="bi bi-person-fill"></i> <strong id="cliente-credito-nombre-pago">-</strong></span>
</div>
<hr class="my-1">
<div class="d-flex justify-content-between small">
<span>Cr√©dito Autorizado:</span>
<strong id="cliente-credito-autorizado-pago">$0.00</strong>
</div>
<div class="d-flex justify-content-between small">
<span>Cr√©dito Utilizado:</span>
<strong id="cliente-credito-utilizado-pago">$0.00</strong>
</div>
<div class="d-flex justify-content-between">
<span>Disponible:</span>
<strong class="text-success" id="cliente-credito-disponible-pago">$0.00</strong>
</div>
</div>
</div>
</div>
</div>

<!-- Monto Recibido y Vuelto (solo para efectivo) -->
<div id="seccion-monto-recibido" class="card mb-3">
<div class="card-body py-2">
<label class="form-label mb-2"><i class="bi bi-cash-stack"></i> Monto Recibido</label>
<!-- Botones de m√∫ltiplos de $5 -->
<div class="row g-2 mb-2" id="botones-monto-rapido">
<!-- Se generan din√°micamente -->
</div>
<div class="input-group">
<span class="input-group-text">$</span>
<input type="number" class="form-control form-control-lg text-end" id="monto-recibido"
       step="0.01" min="0" placeholder="0.00" oninput="calcularVuelto()">
</div>
<!-- Vuelto -->
<div id="vuelto-container" class="mt-2 p-2 rounded text-center" style="display:none;">
<span id="vuelto-label">Vuelto:</span>
<span id="monto-vuelto" class="fs-4 fw-bold">$0.00</span>
</div>
</div>
</div>

</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="button" class="btn btn-outline-success" onclick="confirmarPagoSinComprobante()">
<i class="bi bi-check-circle"></i> Solo Pagar
</button>
<button type="button" class="btn btn-success" onclick="confirmarPagoConComprobante()">
<i class="bi bi-receipt"></i> Pagar y Comprobante
</button>
</div>
</div>
</div>
</div>
<!-- Toast Notificaciones -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
<div id="toast-notification" class="toast" role="alert">
<div class="toast-header">
<i class="bi bi-bell me-2"></i>
<strong class="me-auto" id="toast-title">Notificaci√≥n</strong>
<button type="button" class="btn-close" data-bs-dismiss="toast"></button>
</div>
<div class="toast-body" id="toast-message"></div>
</div>
</div>
<!-- FAB Carrito (Solo m√≥vil) -->
<button class="cart-fab" id="cart-fab" onclick="toggleCartSheet()">
<i class="bi bi-cart3"></i>
<span class="badge" id="cart-fab-count">0</span>
</button>
<!-- Bottom Sheet Carrito (Solo m√≥vil) -->
<div class="cart-sheet-overlay" id="cart-sheet-overlay" onclick="toggleCartSheet()"></div>
<div class="cart-sheet" id="cart-sheet">
<div class="cart-sheet-header">
<div class="drag-handle"></div>
<h5 class="mb-0"><i class="bi bi-cart3"></i> Pedido Actual</h5>
<button class="btn btn-sm btn-outline-secondary" onclick="toggleCartSheet()">
<i class="bi bi-x-lg"></i>
</button>
</div>
<div class="cart-sheet-body" id="cart-sheet-items">
<p class="text-muted text-center py-3">Carrito vac√≠o</p>
</div>
<div class="cart-sheet-footer">
<div class="d-flex justify-content-between align-items-center mb-2">
<small>Sub: <span id="cart-sheet-subtotal">$0.00</span> + IVA: <span id="cart-sheet-iva">$0.00</span></small>
<strong class="text-primary fs-5"><span id="cart-sheet-total">$0.00</span></strong>
</div>
<div class="row g-2 mb-2">
<div class="col-5">
<select class="form-select form-select-sm" id="tipo-pago-mobile" onchange="toggleOpcionesPagoMobile()">
<option value="anticipado">Llevar</option>
<option value="al_final">Mesa</option>
</select>
</div>
<div class="col-7">
<input type="text" class="form-control form-control-sm" id="cliente-nombre-mobile" placeholder="Nombre cliente">
</div>
</div>
<button class="btn btn-primary w-100" onclick="enviarPedidoMobile()" id="btn-enviar-mobile" disabled>
<i class="bi bi-send"></i> Enviar Pedido
</button>
</div>
</div>
<!-- Bottom Navigation (Solo m√≥vil) -->
<nav class="bottom-nav" id="bottom-nav">
<div class="bottom-nav-items">
<button class="bottom-nav-item" onclick="navegarMobile('mesas')" id="nav-mesas">
<i class="bi bi-grid-3x3"></i>
<span>Mesas</span>
</button>
<button class="bottom-nav-item" onclick="navegarMobile('menu')" id="nav-menu">
<i class="bi bi-list-ul"></i>
<span>Men√∫</span>
</button>
<button class="bottom-nav-item" onclick="navegarMobile('servir')" id="nav-servir">
<i class="bi bi-bell"></i>
<span>Servir</span>
</button>
<button class="bottom-nav-item" onclick="logout()">
<i class="bi bi-box-arrow-right"></i>
<span>Salir</span>
</button>
</div>
</nav>

<!-- Audio para notificaciones -->
<audio id="audio-notificacion" preload="auto">
<source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2Onp2bi4N9eoGHkJeXlI2Gf3x5fIOLk5iZlpCJgXt4d3uBiZGXmpiUjoeBfHl4eoGIj5WYl5SSjIZ/enl4eoGHjpSXlpOQi4WAfHl4eX+FjJKVlZOQjIiDf3t5eXuAhoyRlJOSkY2Ig4B8enl7f4SLkJOTkpCNiYSAfXt6e36EiY6RkpGQjoqGgoB8e3t9gYaLj5GRkI+NioaDgH18fH6Ch4uOkJCPjo2KhoOAfn19foKGio2PkI+OjYuIhYKAfn5+gYWJjI6Pjo6NjImGg4GAgIGEh4qMjY2NjIuKiIaEgoGBgoSHiouMjIyMi4qIhoSDgoKDhYeJi4uLi4uKiomHhoSEg4OEhoiJioqKioqJiYiGhYSEhISFh4iJiYmJiYmIh4aFhYWFhYaHiIiIiIiIiIiHhoaFhYWGhoeHiIiIiIeHh4eGhoaGhoaGhoeHh4eHh4eHh4eHhoaGhoaGhoeHh4eHh4eHh4eHh4aGhoaGhoaGh4eHh4eHh4eHh4eHhoaG" type="audio/wav">
</audio>

<!-- ‚úÖ Scripts en orden cr√≠tico -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="js/utils.js"></script>
<script src="js/config.js"></script>
<script src="js/notificaciones.js"></script>

<!-- ‚úÖ GLOBAL ROLE MANAGEMENT SYSTEM -->
<script>
// Estado global del sistema de roles
window.rolSystem = {
  currentRole: null,
  isManager: false,
  notificacionesActivas: null
};

// Mostrar selector de rol (solo para managers)
function mostrarSelectorRol() {
  const usuario = JSON.parse(localStorage.getItem('user') || '{}');
  const rolOriginal = usuario.rol_original || usuario.rol;

  if (rolOriginal !== 'manager') {
    alert('‚ö†Ô∏è Solo managers pueden cambiar de rol');
    return;
  }

  // Ocultar todos los paneles de trabajo
  document.querySelectorAll('.work-panel').forEach(panel => {
    panel.style.display = 'none';
    panel.classList.remove('active');
  });

  // Mostrar el panel-manager con el selector de roles integrado
  const panelManager = document.getElementById('panel-manager');
  if (panelManager) {
    panelManager.style.display = 'block';
    panelManager.classList.add('active');
    // Scroll suave hacia el panel
    panelManager.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Cargar estad√≠sticas del manager
    if (typeof cargarEstadisticasManager === 'function') {
      cargarEstadisticasManager();
    }
  }

  // Actualizar estado global
  window.rolSystem.currentRole = 'manager';
  const currentRoleBadge = document.getElementById('current-role');
  if (currentRoleBadge) {
    currentRoleBadge.textContent = 'Manager';
  }
}

// Aplicar permisos por rol (versi√≥n din√°mica)
function aplicarPermisosPorRol(rol) {
  console.log('[POS] Aplicando permisos para rol:', rol);

  // Verificar si el usuario original es manager
  const usuario = JSON.parse(localStorage.getItem('user') || '{}');
  const rolOriginal = usuario.rol_original || usuario.rol;

  // Actualizar estado global
  window.rolSystem.currentRole = rol;
  window.rolSystem.isManager = (rolOriginal === 'manager');

  // Actualizar badge de rol
  const currentRoleBadge = document.getElementById('current-role');
  if (currentRoleBadge) {
    currentRoleBadge.textContent = rol.charAt(0).toUpperCase() + rol.slice(1);
    currentRoleBadge.classList.remove('d-none');
  }

  // Mostrar/ocultar barra de manager
  const managerToolbar = document.getElementById('manager-toolbar');
  const viewingAsRole = document.getElementById('viewing-as-role');
  if (managerToolbar) {
    if (window.rolSystem.isManager) {
      managerToolbar.classList.remove('d-none');
      if (viewingAsRole) {
        const rolDisplay = rol === 'cocinero' ? 'Cocina' : rol.charAt(0).toUpperCase() + rol.slice(1);
        viewingAsRole.textContent = `Vista: ${rolDisplay}`;
      }
    } else {
      managerToolbar.classList.add('d-none');
    }
  }

  // Bot√≥n de reportes detallados
  const btnReportes = document.getElementById('boton-reportes-detallados');
  if (btnReportes) {
    btnReportes.style.display = window.rolSystem.isManager ? 'block' : 'none';
  }

  // Ocultar selector de rol si est√° visible
  const roleSelector = document.getElementById('role-selector');
  if (roleSelector) {
    roleSelector.style.display = 'none';
  }

  // Ocultar todos los paneles
  document.querySelectorAll('.work-panel').forEach(panel => {
    panel.style.display = 'none';
    panel.classList.remove('active');
  });

  // Mostrar el panel correspondiente al rol
  // Mapeo de rol a panel ID
  const panelMap = {
    'manager': 'panel-manager',
    'mesero': 'panel-mesero',
    'cajero': 'panel-cajero',
    'cocinero': 'panel-cocina'
  };

  const panelId = panelMap[rol];
  const panelActual = document.getElementById(panelId);

  if (panelActual) {
    panelActual.style.display = 'block';
    panelActual.classList.add('active');

    // ===== SISTEMA UNIFICADO: Solo WebSocket, sin polling duplicado =====
    // Limpiar TODOS los intervalos anteriores (legacy cleanup)
    ['intervalPorServir', 'intervalCajero', 'intervalCocina', 'intervalMesas'].forEach(key => {
      if (window[key]) {
        clearInterval(window[key]);
        window[key] = null;
      }
    });

    // Cargar datos iniciales UNA VEZ seg√∫n el rol (sin intervalos)
    if (rol === 'manager') {
      cargarEstadisticasManager();
    }

    if (rol === 'mesero') {
      if (typeof cargarMesas === 'function') cargarMesas();
      if (typeof cargarCategorias === 'function') cargarCategorias();
      if (typeof actualizarPedidosPorServir === 'function') actualizarPedidosPorServir();
    }

    if (rol === 'cajero') {
      if (typeof cargarCategorias === 'function') cargarCategorias();
      if (typeof cargarPedidosCajero === 'function') cargarPedidosCajero();
      if (typeof cargarEstadisticasDia === 'function') cargarEstadisticasDia();
    }

    if (rol === 'cocinero') {
      if (typeof cargarPedidosCocina === 'function') cargarPedidosCocina();
    }

    // Las actualizaciones en tiempo real vienen por WebSocket (ver reinicializarNotificaciones)
    console.log(`[POS] Datos cargados para: ${rol} (actualizaciones por WebSocket)`);
  } else {
    console.warn(`[POS] Panel no encontrado: ${panelId}`);
  }

  // Funci√≥n para cargar estad√≠sticas del manager (con throttle para evitar 429)
  let _managerStatsLoading = false;
  let _managerStatsLastCall = 0;
  const MANAGER_STATS_THROTTLE = 5000; // M√≠nimo 5 segundos entre llamadas

  async function cargarEstadisticasManager() {
    const now = Date.now();

    // Throttle: evitar llamadas muy seguidas
    if (_managerStatsLoading || (now - _managerStatsLastCall) < MANAGER_STATS_THROTTLE) {
      console.log('[Manager] Stats throttled - esperando...');
      return;
    }

    _managerStatsLoading = true;
    _managerStatsLastCall = now;

    try {
      // Cargar reportes del d√≠a
      const respReportes = await apiFetch(`${API_POS}/reportes/hoy`);
      if (respReportes.ok) {
        const datos = await respReportes.json();
        const resumen = datos.resumen || datos;
        document.getElementById('manager-stat-pedidos').textContent = resumen.total_pedidos || 0;
        document.getElementById('manager-stat-ventas').textContent = '$' + (resumen.total_ventas || 0).toFixed(2);
      }

      // Cargar pedidos pendientes
      const respPendientes = await apiFetch(`${API_POS}/cajero/pedidos`);
      if (respPendientes.ok) {
        const pedidos = await respPendientes.json();
        document.getElementById('manager-stat-pendientes').textContent = pedidos.length || 0;
      }

      // Cargar mesas ocupadas
      const respMesas = await apiFetch(`${API_POS}/mesas`);
      if (respMesas.ok) {
        const mesas = await respMesas.json();
        const ocupadas = mesas.filter(m => m.estado === 'ocupada').length;
        document.getElementById('manager-stat-mesas').textContent = ocupadas + '/' + mesas.length;
      }
    } catch (error) {
      console.error('Error cargando estad√≠sticas manager:', error);
    } finally {
      _managerStatsLoading = false;
    }
  }

  // Reinicializar notificaciones
  reinicializarNotificaciones(rol);
}

// Reinicializar sistema de notificaciones
function reinicializarNotificaciones(rol) {
  try {
    const usuario = JSON.parse(localStorage.getItem('user') || '{}');

    // Detener notificaciones anteriores
    if (window.notificacionesCliente) {
      window.notificacionesCliente.desconectar();
    }

    // Crear nueva instancia
    const rolMapa = {
      'cocina': 'cocinero',
      'manager': 'manager',
      'mesero': 'mesero',
      'cajero': 'cajero'
    };

    const notif = new ClienteNotificaciones({
      rol: rolMapa[rol] || rol,
      usuario_id: usuario.id,
      username: usuario.nombre,
      debug: true
    });

    notif.conectar();

    // Registrar handlers
    notif.on('evento_pedido', (evento) => {
      manejarEventoPedido(rol, evento);
    });

    window.notificacionesCliente = notif;
    console.log(`[POS] Notificaciones inicializadas para: ${rol}`);
  } catch (error) {
    console.error('[POS] Error inicializando notificaciones:', error);
  }
}

// ===== SISTEMA DE DEBOUNCE PARA ACTUALIZACIONES =====
const _updateQueue = {};
function actualizarConDebounce(nombre, fn, delay = 500) {
  if (_updateQueue[nombre]) clearTimeout(_updateQueue[nombre]);
  _updateQueue[nombre] = setTimeout(() => {
    if (typeof fn === 'function') fn();
    delete _updateQueue[nombre];
  }, delay);
}

// Manejador centralizado de eventos WebSocket
function manejarEventoPedido(rol, evento) {
  console.log(`[WS-${rol}] Evento:`, evento.tipo);

  // ===== MESERO: Solo notificar pedidos listos =====
  if (rol === 'mesero') {
    if (evento.tipo === 'cambio_estado' && evento.estado === 'listo') {
      mostrarNotificacionToast('Pedido Listo', `Pedido #${evento.pedido_id} listo para servir`, 'success');
    }
    // Actualizar lista de pedidos por servir
    actualizarConDebounce('mesero_pedidos', actualizarPedidosPorServir, 800);
    // Si cambi√≥ estado de mesa (cerrado/pagado), actualizar mesas
    if (evento.tipo === 'cambio_estado' && ['cerrado', 'pagado', 'cancelado'].includes(evento.estado)) {
      actualizarConDebounce('mesero_mesas', cargarMesas, 1000);
    }
  }

  // ===== CAJERO: Actualizar pedidos y estad√≠sticas =====
  if (rol === 'cajero') {
    // Solo notificar eventos importantes
    if (evento.tipo === 'nuevo_pedido' && evento.pedido?.tipo_pago === 'anticipado') {
      mostrarNotificacionToast('Nuevo Pedido', `Para llevar: ${evento.pedido.cliente_nombre || 'Cliente'}`, 'warning');
    }
    // Actualizar lista de pedidos pendientes
    actualizarConDebounce('cajero_pedidos', cargarPedidosCajero, 600);
    // Actualizar estad√≠sticas si hubo pago
    if (evento.tipo === 'cambio_estado' && ['pagado', 'cerrado'].includes(evento.estado)) {
      actualizarConDebounce('cajero_stats', cargarEstadisticasDia, 1000);
    }
  }

  // ===== COCINA: Actualizar pedidos entrantes =====
  if (rol === 'cocina' || rol === 'cocinero') {
    if (evento.tipo === 'nuevo_pedido') {
      mostrarNotificacionToast('Nuevo Pedido', `Mesa ${evento.pedido?.mesa_numero || 'Llevar'}`, 'warning');
    }
    actualizarConDebounce('cocina_pedidos', cargarPedidosCocina, 500);
  }

  // ===== MANAGER: Actualizar estad√≠sticas =====
  if (rol === 'manager') {
    actualizarConDebounce('manager_stats', cargarEstadisticasManager, 1500);
  }
}

// üîÑ Script de verificaci√≥n inicial (usa fetch directo)
// Verificaci√≥n de sesi√≥n activa al cargar
document.addEventListener('DOMContentLoaded', async () => {
  const token = localStorage.getItem('auth_token');
  if (token) {
    try {
      // ‚úÖ Usa fetch directo (sin CSRF) para verificar sesi√≥n
      const response = await fetch('/api/auth/me', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (response.ok) {
        const user = await response.json();
        // Actualizar UI con datos del usuario
        document.getElementById('usuario-nombre-display').textContent = user.nombre || '';
        // Aplicar permisos por rol
        aplicarPermisosPorRol(user.rol);
        return;
      }
    } catch (e) {
      console.warn('Sesi√≥n inv√°lida:', e.message);
    }
    // Limpiar si token inv√°lido
    localStorage.removeItem('auth_token');
    localStorage.removeItem('user');
    window.location.href = 'login.html';
  } else {
    // Redirigir a login si no hay token
    window.location.href = 'login.html';
  }
});

// ‚úÖ Funci√≥n de logout segura
function logout() {
  if (typeof window.limpiarSesion === 'function') {
    window.limpiarSesion();
  } else {
    localStorage.removeItem('auth_token');
    localStorage.removeItem('user');
    sessionStorage.removeItem('csrf_token');
  }
  window.location.href = 'login.html';
}

// ‚úÖ Funci√≥n para mostrar notificaciones toast
function mostrarNotificacionToast(titulo, mensaje, tipo = 'info') {
  try {
    const toastEl = document.getElementById('toast-notification');
    const toastTitle = document.getElementById('toast-title');
    const toastBody = document.getElementById('toast-message');

    if (!toastEl || !toastTitle || !toastBody) return;

    toastTitle.textContent = titulo;
    toastBody.textContent = mensaje;

    const toastHeader = toastEl.querySelector('.toast-header');
    if (toastHeader) {
      toastHeader.className = 'toast-header';
      if (tipo === 'success') {
        toastHeader.classList.add('bg-success', 'text-white');
      } else if (tipo === 'warning') {
        toastHeader.classList.add('bg-warning', 'text-dark');
      } else if (tipo === 'danger') {
        toastHeader.classList.add('bg-danger', 'text-white');
      } else {
        toastHeader.classList.add('bg-info', 'text-white');
      }
    }

    const bsToast = new bootstrap.Toast(toastEl, { delay: 5000 });
    bsToast.show();
  } catch (error) {
    console.error('Error mostrando notificaci√≥n:', error);
  }
}

// ‚úÖ Cambio de rol (solo para manager)
function seleccionarRol(nuevoRol) {
  const usuario = JSON.parse(localStorage.getItem('user') || '{}');

  // Check if user's ORIGINAL role is manager (for manager users who switched roles)
  const rolOriginal = usuario.rol_original || usuario.rol;
  const esManager = usuario.rol === 'manager' || rolOriginal === 'manager';

  if (!esManager) {
    mostrarNotificacionToast('Acceso Denegado', 'Solo managers pueden cambiar de rol', 'danger');
    return;
  }

  const rolesPermitidos = ['mesero', 'cajero', 'cocinero', 'manager'];
  if (!rolesPermitidos.includes(nuevoRol)) {
    console.error('‚ùå Rol no v√°lido:', nuevoRol);
    return;
  }

  // Preserve original role for managers
  if (!usuario.rol_original && usuario.rol === 'manager') {
    usuario.rol_original = 'manager';
  }

  // Update display role (simulate role)
  usuario.rol = nuevoRol;
  localStorage.setItem('user', JSON.stringify(usuario));

  // Apply UI changes
  aplicarPermisosPorRol(nuevoRol);
  mostrarNotificacionToast('Rol Simulado', `Viendo como ${nuevoRol}`, 'success');

  console.log(`‚úÖ Rol simulado a: ${nuevoRol} (rol original: ${usuario.rol_original})`);
}
</script>

<!-- Scripts principales -->
<script src="js/role-control.js"></script>
<script src="js/auth-check.js?v=5"></script>
<script src="js/pos.js?v=20"></script>

</body>
</html>
