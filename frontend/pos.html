<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#e65100">
<title>POS Pupuser√≠a - Sistema de Pedidos</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="css/styles-responsive.css">
<link rel="stylesheet" href="css/pos.css">
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-pos navbar-dark">
<div class="container-fluid">
<span class="navbar-brand mb-0 h1">
<i class="bi bi-shop"></i> POS Pupuser√≠a
</span>
<div class="d-flex align-items-center gap-3 flex-wrap">
<span id="current-role" class="badge bg-light text-dark d-none"></span>
<span class="text-white d-none d-md-inline" id="usuario-info">
<i class="bi bi-person-circle"></i>
<span id="usuario-nombre-display"></span>
</span>
<span id="current-time" class="text-white d-none d-md-inline"></span>
<!-- Men√∫ desplegable para navegaci√≥n (responsive) -->
<div class="dropdown">
<button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="navDropdown" data-bs-toggle="dropdown" aria-expanded="false">
<i class="bi bi-list"></i> <span class="d-md-none">Men√∫</span><span class="d-none d-md-inline">Opciones</span>
</button>
<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navDropdown" style="min-width: 180px;">
<!-- Cambiar Rol - Solo para Manager -->
<li id="li-cambiar-rol" class="d-none">
<button class="dropdown-item" onclick="mostrarSelectorRol()">
<i class="bi bi-arrow-repeat"></i> Cambiar Rol
</button>
</li>
<!-- Administraci√≥n - Solo para Manager -->
<li id="li-admin" class="d-none">
<a class="dropdown-item" href="admin.html">
<i class="bi bi-gear"></i> Administraci√≥n
</a>
</li>
<!-- Facturaci√≥n - Solo para Manager -->
<li id="li-factura" class="d-none">
<a class="dropdown-item" href="index.html">
<i class="bi bi-receipt"></i> Facturaci√≥n
</a>
</li>
<li><hr class="dropdown-divider"></li>
<li>
<button class="dropdown-item" onclick="logout()">
<i class="bi bi-box-arrow-right"></i> Salir
</button>
</li>
</ul>
</div>
<!-- Botones en desktop (ocultos en m√≥vil) -->
<div id="manager-nav-links" class="d-none d-lg-flex gap-2">
<a href="index.html" class="btn btn-outline-light btn-sm">
<i class="bi bi-receipt"></i> <span class="d-none d-xl-inline">Facturaci√≥n</span>
</a>
<a href="admin.html" class="btn btn-outline-light btn-sm">
<i class="bi bi-gear"></i> <span class="d-none d-xl-inline">Administraci√≥n</span>
</a>
<button id="btn-cambiar-rol" class="btn btn-outline-light btn-sm d-none">
<i class="bi bi-arrow-repeat"></i> <span class="d-none d-xl-inline">Cambiar Rol</span>
</button>
</div>
</div>
</div>
</nav>
<div class="container-fluid mt-4">
<!-- Selector de Rol (oculto por defecto, solo visible para managers) -->
<div id="role-selector" class="role-selector mx-auto" style="max-width: 800px; display: none;">
<h3 class="text-center mb-4">Selecciona tu rol</h3>
<div class="row g-4">
<div class="col-md-4">
<div class="card role-card h-100 text-center p-4" onclick="seleccionarRol('mesero')">
<div class="role-icon role-mesero">
<i class="bi bi-person-badge"></i>
</div>
<h4>Mesero</h4>
<p class="text-muted">Tomar pedidos y servir mesas</p>
</div>
</div>
<div class="col-md-4">
<div class="card role-card h-100 text-center p-4" onclick="seleccionarRol('cajero')">
<div class="role-icon role-cajero">
<i class="bi bi-cash-register"></i>
</div>
<h4>Cajero</h4>
<p class="text-muted">Procesar pagos y facturar</p>
</div>
</div>
<div class="col-md-4">
<div class="card role-card h-100 text-center p-4" onclick="seleccionarRol('cocina')">
<div class="role-icon role-cocina">
<i class="bi bi-fire"></i>
</div>
<h4>Cocina</h4>
<p class="text-muted">Preparar pedidos</p>
</div>
</div>
</div>
</div>
<!-- Panel Mesero -->
<div id="panel-mesero" class="work-panel">
<div class="row">
<!-- Mesas y Men√∫ -->
<div class="col-lg-8">
<ul class="nav nav-tabs mb-3" id="meseroTabs">
<li class="nav-item">
<button class="nav-link active" data-bs-toggle="tab" data-bs-target="#mesas-tab">
<i class="bi bi-grid-3x3"></i> Mesas
</button>
</li>
<li class="nav-item">
<button class="nav-link" data-bs-toggle="tab" data-bs-target="#menu-tab">
<i class="bi bi-menu-button-wide"></i> Men√∫
</button>
</li>
<li class="nav-item position-relative">
<button class="nav-link" data-bs-toggle="tab" data-bs-target="#servir-tab">
<i class="bi bi-bell"></i> Por Servir
<span id="badge-servir" class="notification-badge d-none">0</span>
</button>
</li>
</ul>
<div class="tab-content">
<!-- Tab Mesas -->
<div class="tab-pane fade show active" id="mesas-tab">
<div class="mesa-grid" id="mesas-container"></div>
</div>
<!-- Tab Men√∫ -->
<div class="tab-pane fade" id="menu-tab">
<div class="categoria-tabs" id="categorias-container"></div>
<div class="menu-grid" id="productos-container"></div>
</div>
<!-- Tab Por Servir -->
<div class="tab-pane fade" id="servir-tab">
<div id="pedidos-servir-container"></div>
</div>
</div>
</div>
<!-- Carrito -->
<div class="col-lg-4">
<div class="cart-panel">
<div class="p-3 border-bottom">
<h5 class="mb-0">
<i class="bi bi-cart3"></i> Pedido Actual
<span id="mesa-seleccionada" class="badge bg-primary ms-2"></span>
</h5>
</div>
<div class="cart-items" id="cart-items">
<p class="text-muted text-center">Selecciona productos del men√∫</p>
</div>
<div class="cart-total">
<div class="d-flex justify-content-between mb-2">
<span>Subtotal:</span>
<span id="cart-subtotal">$0.00</span>
</div>
<div class="d-flex justify-content-between mb-2">
<span>IVA (13%):</span>
<span id="cart-iva">$0.00</span>
</div>
<div class="d-flex justify-content-between mb-3">
<strong>Total:</strong>
<strong id="cart-total">$0.00</strong>
</div>
<div class="mb-2">
<select class="form-select form-select-sm" id="tipo-pago" onchange="if(typeof toggleOpcionesPago === 'function'){ toggleOpcionesPago(); }">
<option value="anticipado">Pago anticipado (para llevar)</option>
<option value="al_final">Pago al final (en mesa)</option>
</select>
</div>
<div id="opciones-para-llevar" class="mb-2">
<input type="text" class="form-control form-control-sm" id="cliente-nombre-pedido" placeholder="Nombre del cliente">
</div>
<button class="btn btn-primary w-100" onclick="enviarPedido()" id="btn-enviar-pedido" disabled>
<i class="bi bi-send"></i> Enviar Pedido
</button>
</div>
</div>
</div>
</div>
</div>
<!-- Panel Cajero -->
<div id="panel-cajero" class="work-panel">
<ul class="nav nav-tabs mb-3" id="cajeroTabs">
<li class="nav-item">
<button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cajero-cobros-tab">
<i class="bi bi-cash-stack"></i> Cobros Pendientes
</button>
</li>
<li class="nav-item">
<button class="nav-link" data-bs-toggle="tab" data-bs-target="#cajero-pedido-tab">
<i class="bi bi-bag-plus"></i> Nuevo Pedido
</button>
</li>
<li class="nav-item">
<button class="nav-link" data-bs-toggle="tab" data-bs-target="#cajero-creditos-tab">
<i class="bi bi-credit-card-2-front"></i> Gesti√≥n Cr√©ditos
</button>
</li>
<li class="nav-item">
<button class="nav-link" data-bs-toggle="tab" data-bs-target="#cajero-reportes-tab">
<i class="bi bi-graph-up"></i> Reportes R√°pidos
</button>
</li>
</ul>
<div class="tab-content">
<!-- Tab Cobros Pendientes -->
<div class="tab-pane fade show active" id="cajero-cobros-tab">
<div class="row">
<div class="col-lg-8">
<h5 class="mb-3"><i class="bi bi-hourglass-split"></i> Pedidos Pendientes de Pago</h5>
<div id="pedidos-cajero-container"></div>
</div>
<div class="col-lg-4">
<div class="card">
<div class="card-header bg-success text-white">
<h5 class="mb-0"><i class="bi bi-graph-up"></i> Resumen del D√≠a</h5>
</div>
<div class="card-body">
<div class="d-flex justify-content-between mb-2">
<span>Pedidos cerrados:</span>
<strong id="stat-pedidos">0</strong>
</div>
<div class="d-flex justify-content-between mb-2">
<span>Ventas totales:</span>
<strong id="stat-ventas">$0.00</strong>
</div>
<hr>
<h6>Top Productos</h6>
<ul id="stat-top-productos" class="list-unstyled small"></ul>
</div>
</div>
</div>
</div>
</div>
<!-- Tab Nuevo Pedido (Para Llevar) -->
<div class="tab-pane fade" id="cajero-pedido-tab">
<div class="row">
<div class="col-lg-8">
<div class="alert alert-info mb-3">
<i class="bi bi-info-circle"></i> <strong>Pedido Para Llevar:</strong> Crea pedidos directamente y cobra al momento.
</div>
<div class="categoria-tabs" id="categorias-container-cajero"></div>
<div class="menu-grid" id="productos-container-cajero"></div>
</div>
<div class="col-lg-4">
<div class="cart-panel" id="cart-panel-cajero">
<div class="p-3 border-bottom">
<h5 class="mb-0">
<i class="bi bi-bag"></i> Pedido Para Llevar
</h5>
</div>
<div class="cart-items" id="cart-items-cajero">
<p class="text-muted text-center">Selecciona productos del men√∫</p>
</div>
<div class="cart-total">
<div class="d-flex justify-content-between mb-2">
<span>Subtotal:</span>
<span id="cart-subtotal-cajero">$0.00</span>
</div>
<div class="d-flex justify-content-between mb-2">
<span>IVA (13%):</span>
<span id="cart-iva-cajero">$0.00</span>
</div>
<div class="d-flex justify-content-between mb-3">
<strong>Total:</strong>
<strong id="cart-total-cajero">$0.00</strong>
</div>
<div class="mb-2">
<input type="text" class="form-control" id="cliente-nombre-cajero" placeholder="Nombre del cliente (requerido)">
</div>
<button class="btn btn-success w-100" onclick="crearPedidoCajero()" id="btn-crear-pedido-cajero" disabled>
<i class="bi bi-cash-coin"></i> Crear y Cobrar
</button>
</div>
</div>
</div>
</div>
</div>
<!-- Tab Gesti√≥n de Cr√©ditos -->
<div class="tab-pane fade" id="cajero-creditos-tab">
<div class="row">
<div class="col-lg-6">
<div class="card mb-3">
<div class="card-header bg-warning">
<h5 class="mb-0"><i class="bi bi-person-plus"></i> Otorgar/Modificar Cr√©dito</h5>
</div>
<div class="card-body">
<div class="mb-3">
<label class="form-label">Buscar Cliente</label>
<input type="text" class="form-control" id="buscar-cliente-credito"
placeholder="Nombre, DUI o NIT..." onkeyup="buscarClienteCredito(this.value)">
<div id="resultados-cliente-credito" class="list-group mt-2"></div>
</div>
<div id="form-credito-cliente" style="display:none;">
<hr>
<h6 id="nombre-cliente-credito"></h6>
<input type="hidden" id="id-cliente-credito">
<div class="row mb-3">
<div class="col-6">
<label class="form-label">Cr√©dito Autorizado ($)</label>
<input type="number" class="form-control" id="monto-credito-autorizado" min="0" step="0.01">
</div>
<div class="col-6">
<label class="form-label">D√≠as de Cr√©dito</label>
<input type="number" class="form-control" id="dias-credito-cliente" min="0">
</div>
</div>
<div class="alert alert-secondary mb-3">
<div class="d-flex justify-content-between">
<span>Cr√©dito Utilizado:</span>
<strong id="credito-utilizado-info">$0.00</strong>
</div>
<div class="d-flex justify-content-between">
<span>Cr√©dito Disponible:</span>
<strong id="credito-disponible-info">$0.00</strong>
</div>
</div>
<button class="btn btn-warning w-100" onclick="guardarCreditoCliente()">
<i class="bi bi-save"></i> Guardar Cr√©dito
</button>
</div>
</div>
</div>
</div>
<div class="col-lg-6">
<div class="card">
<div class="card-header bg-info text-white">
<h5 class="mb-0"><i class="bi bi-list-check"></i> Ventas a Cr√©dito Pendientes</h5>
</div>
<div class="card-body" style="max-height: 400px; overflow-y: auto;">
<div id="lista-creditos-pendientes">
<p class="text-muted text-center">Cargando...</p>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Tab Reportes R√°pidos -->
<div class="tab-pane fade" id="cajero-reportes-tab">
<!-- Selector de per√≠odo r√°pido -->
<div class="row mb-3">
<div class="col-md-12">
<div class="btn-group w-100" role="group">
<input type="radio" class="btn-check" name="periodoReportes" id="periodo-hoy" value="hoy" checked onchange="cambiarPeriodoReportes('hoy')">
<label class="btn btn-outline-primary" for="periodo-hoy">
<i class="bi bi-calendar-day"></i> Hoy
</label>
<input type="radio" class="btn-check" name="periodoReportes" id="periodo-7d" value="7d" onchange="cambiarPeriodoReportes('7d')">
<label class="btn btn-outline-primary" for="periodo-7d">
<i class="bi bi-calendar-week"></i> √öltimos 7 d√≠as
</label>
<input type="radio" class="btn-check" name="periodoReportes" id="periodo-30d" value="30d" onchange="cambiarPeriodoReportes('30d')">
<label class="btn btn-outline-primary" for="periodo-30d">
<i class="bi bi-calendar-month"></i> √öltimo mes
</label>
</div>
</div>
</div>
<!-- Tarjetas de M√©tricas -->
<div class="row" id="metricas-reportes">
<div class="col-md-3 mb-3">
<div class="card">
<div class="card-body">
<h6 class="card-title text-muted">Total Vendido</h6>
<h3 class="mb-0" id="metrica-total-ventas">$0.00</h3>
<small id="metrica-variacion-ventas" class="text-success"></small>
</div>
</div>
</div>
<div class="col-md-3 mb-3">
<div class="card">
<div class="card-body">
<h6 class="card-title text-muted">Total Pedidos</h6>
<h3 class="mb-0" id="metrica-total-pedidos">0</h3>
<small id="metrica-variacion-pedidos" class="text-success"></small>
</div>
</div>
</div>
<div class="col-md-3 mb-3">
<div class="card">
<div class="card-body">
<h6 class="card-title text-muted">Ticket Promedio</h6>
<h3 class="mb-0" id="metrica-ticket-promedio">$0.00</h3>
<small id="metrica-variacion-promedio" class="text-success"></small>
</div>
</div>
</div>
<div class="col-md-3 mb-3">
<div class="card">
<div class="card-body">
<h6 class="card-title text-muted">Efectivo vs Cr√©dito</h6>
<div class="d-flex justify-content-between">
<small><strong>Efectivo:</strong> <span id="metrica-efectivo">$0.00</span></small>
<small><strong>Cr√©dito:</strong> <span id="metrica-credito">$0.00</span></small>
</div>
</div>
</div>
</div>
</div>
<!-- Top Productos del per√≠odo -->
<div class="row">
<div class="col-md-6">
<div class="card">
<div class="card-header">
<h6 class="mb-0"><i class="bi bi-bar-chart"></i> Top Productos</h6>
</div>
<div class="card-body" style="max-height: 300px; overflow-y: auto;">
<div id="tabla-top-productos">
<p class="text-muted text-center">Cargando...</p>
</div>
</div>
</div>
</div>
<!-- Desglose por Categor√≠a -->
<div class="col-md-6">
<div class="card">
<div class="card-header">
<h6 class="mb-0"><i class="bi bi-tag"></i> Ventas por Categor√≠a</h6>
</div>
<div class="card-body" style="max-height: 300px; overflow-y: auto;">
<div id="tabla-categorias">
<p class="text-muted text-center">Cargando...</p>
</div>
</div>
</div>
</div>
</div>
<!-- Bot√≥n para acceder a reportes detallados (solo para managers) -->
<div class="row mt-3" id="boton-reportes-detallados" style="display: none;">
<div class="col-md-12">
<a href="reportes.html" class="btn btn-primary w-100" target="_blank">
<i class="bi bi-file-earmark-text"></i> Ver Reportes Detallados
</a>
</div>
</div>
</div>
</div>
</div>
<!-- Panel Cocina -->
<div id="panel-cocina" class="work-panel">
<h4 class="mb-3"><i class="bi bi-fire"></i> Pedidos en Cola</h4>
<div class="row" id="pedidos-cocina-container"></div>
</div>
</div>
<!-- Modal Confirmar Pago -->
<div class="modal fade" id="modalPago" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header bg-success text-white">
<h5 class="modal-title"><i class="bi bi-cash"></i> Confirmar Pago</h5>
<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<div class="row">
<div class="col-md-6">
<div id="detalle-pago"></div>
<hr>
<!-- M√©todo de Pago -->
<h6 class="mb-2"><i class="bi bi-wallet2"></i> M√©todo de Pago</h6>
<div class="btn-group w-100 mb-3" role="group">
<input type="radio" class="btn-check" name="metodoPago" id="pago-efectivo" value="efectivo" checked onchange="onMetodoPagoChange()">
<label class="btn btn-outline-success" for="pago-efectivo">
<i class="bi bi-cash"></i> Efectivo
</label>
<input type="radio" class="btn-check" name="metodoPago" id="pago-credito" value="credito" onchange="onMetodoPagoChange()">
<label class="btn btn-outline-warning" for="pago-credito">
<i class="bi bi-credit-card"></i> Cr√©dito
</label>
</div>
<!-- Alerta de cr√©dito del cliente -->
<div id="info-credito-cliente" class="alert alert-warning d-none mb-3">
<div class="d-flex justify-content-between align-items-center">
<div>
<i class="bi bi-credit-card"></i> <strong>Cr√©dito disponible:</strong>
<span id="credito-disponible-pago">$0.00</span>
</div>
<small class="text-muted">
Usado: <span id="credito-usado-pago">$0.00</span> /
<span id="credito-limite-pago">$0.00</span>
</small>
</div>
<div class="progress mt-2" style="height: 8px;">
<div id="barra-credito-pago" class="progress-bar bg-warning" style="width: 0%"></div>
</div>
</div>
<!-- Alerta cuando no tiene cr√©dito -->
<div id="alerta-sin-credito" class="alert alert-danger d-none mb-3">
<i class="bi bi-exclamation-triangle"></i>
<strong>Sin cr√©dito disponible.</strong>
<span id="mensaje-sin-credito">Seleccione un cliente con cr√©dito autorizado.</span>
</div>
<!-- Monto recibido (solo para efectivo) -->
<div id="seccion-monto-recibido" class="mb-3">
<label class="form-label">Monto recibido:</label>
<input type="number" class="form-control form-control-lg" id="monto-recibido" step="0.01">
</div>
<div class="alert alert-info" id="cambio-container" style="display:none;">
<strong>Cambio: <span id="monto-cambio">$0.00</span></strong>
</div>
</div>
<div class="col-md-6">
<h6 class="mb-3"><i class="bi bi-receipt"></i> Tipo de Comprobante</h6>
<div class="form-check mb-2">
<input class="form-check-input" type="radio" name="tipoComprobante" id="tipo-ticket" value="ticket" checked onchange="toggleSeccionPropina()">
<label class="form-check-label" for="tipo-ticket">
<strong>Ticket</strong> - Comprobante simple (no fiscal)
</label>
</div>
<div class="form-check mb-3">
<input class="form-check-input" type="radio" name="tipoComprobante" id="tipo-factura" value="factura" onchange="toggleSeccionPropina()">
<label class="form-check-label" for="tipo-factura">
<strong>Factura Electr√≥nica</strong> - DTE (requiere datos)
</label>
</div>
<!-- Opci√≥n de Propina (solo para ticket/efectivo) -->
<div id="seccion-propina" class="mb-3">
<hr>
<h6 class="mb-2"><i class="bi bi-gift"></i> Propina (Opcional)</h6>
<div class="row g-2 mb-2">
<div class="col-auto">
<button type="button" class="btn btn-outline-secondary btn-sm" onclick="establecerPropina(0)">Sin propina</button>
</div>
<div class="col-auto">
<button type="button" class="btn btn-outline-secondary btn-sm" onclick="establecerPropina(0.05)">5%</button>
</div>
<div class="col-auto">
<button type="button" class="btn btn-outline-secondary btn-sm" onclick="establecerPropina(0.10)">10%</button>
</div>
<div class="col-auto">
<button type="button" class="btn btn-outline-secondary btn-sm" onclick="establecerPropina(0.15)">15%</button>
</div>
</div>
<div class="input-group input-group-sm">
<span class="input-group-text">$</span>
<input type="number" class="form-control" id="propina-monto" placeholder="Monto personalizado" step="0.01" min="0" onchange="actualizarPropinaPersonalizada()">
</div>
<small class="text-muted d-block mt-1">Propina: <span id="propina-display">$0.00</span></small>
</div>
<!-- Datos del cliente (para factura) -->
<div id="datos-cliente-container" style="display:none;">
<hr>
<h6 class="mb-3"><i class="bi bi-person"></i> Datos del Cliente</h6>
<!-- Buscador de cliente -->
<div class="mb-3">
<div class="input-group input-group-sm">
<span class="input-group-text"><i class="bi bi-search"></i></span>
<input type="text" class="form-control" id="buscar-cliente-factura"
placeholder="Buscar cliente por nombre, DUI, NIT..."
onkeyup="buscarClienteFactura(this.value)">
<button class="btn btn-outline-primary" type="button" onclick="limpiarClienteFactura()">
<i class="bi bi-x"></i>
</button>
</div>
<div id="resultados-busqueda-cliente" class="list-group position-absolute w-100" style="z-index: 1050; max-height: 200px; overflow-y: auto;"></div>
</div>
<input type="hidden" id="cliente-id-factura">
<div class="mb-2">
<input type="text" class="form-control form-control-sm" id="cliente-nombre" placeholder="Nombre del cliente">
</div>
<div class="row mb-2">
<div class="col-6">
<select class="form-select form-select-sm" id="cliente-tipo-doc">
<option value="">Sin documento</option>
<option value="36">NIT</option>
<option value="13">DUI</option>
<option value="37">Otro</option>
</select>
</div>
<div class="col-6">
<input type="text" class="form-control form-control-sm" id="cliente-num-doc" placeholder="N√∫mero documento">
</div>
</div>
<div class="mb-2">
<input type="text" class="form-control form-control-sm" id="cliente-nrc" placeholder="NRC (opcional)">
</div>
<div class="mb-2">
<input type="text" class="form-control form-control-sm" id="cliente-direccion" placeholder="Direcci√≥n">
</div>
<div class="row mb-2">
<div class="col-6">
<input type="tel" class="form-control form-control-sm" id="cliente-telefono" placeholder="Tel√©fono">
</div>
<div class="col-6">
<input type="email" class="form-control form-control-sm" id="cliente-correo" placeholder="Correo">
</div>
</div>
<div class="row mb-2 d-none">
<div class="col-md-6">
<label class="form-label small">Cr√©dito Autorizado ($)</label>
<input type="number" class="form-control form-control-sm" id="cliente-credito" min="0" step="0.01" value="0">
</div>
<div class="col-md-6">
<label class="form-label small">D√≠as de Cr√©dito</label>
<input type="number" class="form-control form-control-sm" id="cliente-dias-credito" min="0" value="0">
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="button" class="btn btn-outline-success" onclick="confirmarPagoSinComprobante()">
<i class="bi bi-check-circle"></i> Solo Pagar
</button>
<button type="button" class="btn btn-success" onclick="confirmarPagoConComprobante()">
<i class="bi bi-receipt"></i> Pagar y Emitir Comprobante
</button>
</div>
</div>
</div>
</div>
<!-- Toast Notificaciones -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
<div id="toast-notification" class="toast" role="alert">
<div class="toast-header">
<i class="bi bi-bell me-2"></i>
<strong class="me-auto" id="toast-title">Notificaci√≥n</strong>
<button type="button" class="btn-close" data-bs-dismiss="toast"></button>
</div>
<div class="toast-body" id="toast-message"></div>
</div>
</div>
<!-- FAB Carrito (Solo m√≥vil) -->
<button class="cart-fab" id="cart-fab" onclick="toggleCartSheet()">
<i class="bi bi-cart3"></i>
<span class="badge" id="cart-fab-count">0</span>
</button>
<!-- Bottom Sheet Carrito (Solo m√≥vil) -->
<div class="cart-sheet-overlay" id="cart-sheet-overlay" onclick="toggleCartSheet()"></div>
<div class="cart-sheet" id="cart-sheet">
<div class="cart-sheet-header">
<div class="drag-handle"></div>
<h5 class="mb-0"><i class="bi bi-cart3"></i> Pedido Actual</h5>
<button class="btn btn-sm btn-outline-secondary" onclick="toggleCartSheet()">
<i class="bi bi-x-lg"></i>
</button>
</div>
<div class="cart-sheet-body" id="cart-sheet-items">
<p class="text-muted text-center py-3">Carrito vac√≠o</p>
</div>
<div class="cart-sheet-footer">
<div class="d-flex justify-content-between align-items-center mb-2">
<small>Sub: <span id="cart-sheet-subtotal">$0.00</span> + IVA: <span id="cart-sheet-iva">$0.00</span></small>
<strong class="text-primary fs-5"><span id="cart-sheet-total">$0.00</span></strong>
</div>
<div class="row g-2 mb-2">
<div class="col-5">
<select class="form-select form-select-sm" id="tipo-pago-mobile" onchange="toggleOpcionesPagoMobile()">
<option value="anticipado">Llevar</option>
<option value="al_final">Mesa</option>
</select>
</div>
<div class="col-7">
<input type="text" class="form-control form-control-sm" id="cliente-nombre-mobile" placeholder="Nombre cliente">
</div>
</div>
<button class="btn btn-primary w-100" onclick="enviarPedidoMobile()" id="btn-enviar-mobile" disabled>
<i class="bi bi-send"></i> Enviar Pedido
</button>
</div>
</div>
<!-- Bottom Navigation (Solo m√≥vil) -->
<nav class="bottom-nav" id="bottom-nav">
<div class="bottom-nav-items">
<button class="bottom-nav-item" onclick="navegarMobile('mesas')" id="nav-mesas">
<i class="bi bi-grid-3x3"></i>
<span>Mesas</span>
</button>
<button class="bottom-nav-item" onclick="navegarMobile('menu')" id="nav-menu">
<i class="bi bi-list-ul"></i>
<span>Men√∫</span>
</button>
<button class="bottom-nav-item" onclick="navegarMobile('servir')" id="nav-servir">
<i class="bi bi-bell"></i>
<span>Servir</span>
</button>
<button class="bottom-nav-item" onclick="logout()">
<i class="bi bi-box-arrow-right"></i>
<span>Salir</span>
</button>
</div>
</nav>

<!-- ‚úÖ Scripts en orden cr√≠tico -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="js/utils.js"></script>
<script src="js/config.js"></script>
<script src="js/notificaciones.js"></script>

<!-- üîÑ Script de verificaci√≥n inicial (usa fetch directo) -->
<script>
// Verificaci√≥n de sesi√≥n activa al cargar
document.addEventListener('DOMContentLoaded', async () => {
  const token = localStorage.getItem('auth_token');
  if (token) {
    try {
      // ‚úÖ Usa fetch directo (sin CSRF) para verificar sesi√≥n
      const response = await fetch('/api/auth/me', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (response.ok) {
        const user = await response.json();
        // Actualizar UI con datos del usuario
        document.getElementById('usuario-nombre-display').textContent = user.nombre || '';
        // Mostrar opciones seg√∫n rol
        actualizarInterfazPorRol(user.rol);
        return;
      }
    } catch (e) {
      console.warn('Sesi√≥n inv√°lida:', e.message);
    }
    // Limpiar si token inv√°lido
    localStorage.removeItem('auth_token');
    localStorage.removeItem('user');
    window.location.href = 'login.html';
  } else {
    // Redirigir a login si no hay token
    window.location.href = 'login.html';
  }
});

// Funci√≥n auxiliar: mostrar UI seg√∫n rol
function actualizarInterfazPorRol(rol) {
  // 1. Definir si es manager
  const isManager = rol === 'manager';

  // 2. Gestionar visibilidad de elementos del men√∫ superior
  document.getElementById('li-cambiar-rol')?.classList.toggle('d-none', !isManager);
  document.getElementById('li-admin')?.classList.toggle('d-none', !isManager);
  document.getElementById('li-factura')?.classList.toggle('d-none', !isManager);
  document.getElementById('btn-cambiar-rol')?.classList.toggle('d-none', !isManager);

  // 3. CORRECCI√ìN: Definir la variable btnReportes correctamente
  const btnReportes = document.getElementById('boton-reportes-detallados');
  if (btnReportes) {
    btnReportes.style.display = isManager ? 'block' : 'none';
  }

  // 4. Limpieza: Ocultar TODOS los paneles antes de activar el correspondiente
  // Esto evita que se encimen vistas de otros roles
  document.querySelectorAll('.work-panel').forEach(panel => {
    panel.classList.remove('active');
    panel.style.display = 'none'; // Aseguramos que se oculte f√≠sicamente
  });

  // 5. Activar panel seg√∫n rol
  if (['mesero', 'cajero', 'cocina', 'manager'].includes(rol)) {
    const panelId = `panel-${rol}`;
    const panelActual = document.getElementById(panelId);

    if (panelActual) {
      panelActual.classList.add('active');
      panelActual.style.display = 'block'; // Fuerza la visibilidad

      // ‚úÖ IMPORTANTE: Si es mesero, disparar la carga de mesas y men√∫
      if (rol === 'mesero' || rol === 'manager') {
          console.log("Activando vista de mesero: Cargando componentes...");
          if (typeof cargarMesas === 'function') cargarMesas();
          if (typeof cargarCategorias === 'function') cargarCategorias();
      }
    }
  } else {
    const selector = document.getElementById('role-selector');
    if (selector) selector.style.display = 'block';
  }

  // 6. Inicializar/reinicializar notificaciones seg√∫n el rol
  try {
    const usuario = JSON.parse(localStorage.getItem('user') || '{}');

    // Detener notificaciones anteriores si existen
    if (window.notificacionesCliente) {
      window.notificacionesCliente.desconectar();
    }

    // Crear nueva instancia de notificaciones
    const notif = new ClienteNotificaciones({
      rol: rol === 'cocina' ? 'cocinero' : (rol === 'manager' ? 'manager' : rol),
      usuario_id: usuario.id,
      username: usuario.nombre,
      debug: true
    });

    notif.conectar();

    // Registrar handlers seg√∫n el rol
    notif.on('evento_pedido', (evento) => {
      console.log(`[POS-${rol}] Evento recibido:`, evento.tipo, evento);

      // Mesero: notificaciones cuando pedidos est√°n listos
      if (rol === 'mesero' && evento.tipo === 'cambio_estado' && evento.estado === 'listo') {
        mostrarNotificacionToast('Pedido Listo', `Pedido #${evento.pedido_id} est√° listo para servir`, 'success');
        if (typeof actualizarPedidosPorServir === 'function') {
          actualizarPedidosPorServir();
        }
      }

      // Cajero: notificaciones de cambios de estado y facturaci√≥n
      if (rol === 'cajero') {
        if (evento.tipo === 'cambio_estado') {
          mostrarNotificacionToast('Cambio de Estado', `Pedido #${evento.pedido_id} cambi√≥ a ${evento.estado}`, 'info');
        } else if (evento.tipo === 'factura_generada' || evento.tipo === 'ticket_generado') {
          mostrarNotificacionToast('Comprobante', `Comprobante generado para pedido #${evento.pedido_id}`, 'success');
        }
        if (typeof cargarPedidosCajero === 'function') {
          cargarPedidosCajero();
        }
      }

      // Cocina: notificaciones de nuevos pedidos
      if (rol === 'cocina' && evento.tipo === 'nuevo_pedido') {
        mostrarNotificacionToast('Nuevo Pedido', `Mesa ${evento.pedido.mesa_numero || 'Para Llevar'}`, 'warning');
        if (typeof cargarPedidosCocina === 'function') {
          cargarPedidosCocina();
        }
      }

      // Manager: todas las notificaciones
      if (rol === 'manager') {
        console.log('[Manager] Evento de negocio:', evento.tipo, evento);
      }
    });

    window.notificacionesCliente = notif;
    console.log(`[POS] Notificaciones inicializadas para rol: ${rol}`);
  } catch (error) {
    console.error('[POS] Error inicializando notificaciones:', error);
  }
}
// Funci√≥n de logout segura
function logout() {
  if (typeof window.limpiarSesion === 'function') {
    window.limpiarSesion();
  } else {
    localStorage.removeItem('auth_token');
    localStorage.removeItem('user');
    sessionStorage.removeItem('csrf_token');
  }
  window.location.href = 'login.html';
}

// Funci√≥n para mostrar notificaciones toast
function mostrarNotificacionToast(titulo, mensaje, tipo = 'info') {
  try {
    const toastEl = document.getElementById('toast-notification');
    const toastTitle = document.getElementById('toast-title');
    const toastBody = document.getElementById('toast-message');

    if (!toastEl || !toastTitle || !toastBody) return;

    toastTitle.textContent = titulo;
    toastBody.textContent = mensaje;

    // Cambiar color del header seg√∫n tipo
    const toastHeader = toastEl.querySelector('.toast-header');
    if (toastHeader) {
      toastHeader.className = 'toast-header';
      if (tipo === 'success') {
        toastHeader.classList.add('bg-success', 'text-white');
      } else if (tipo === 'warning') {
        toastHeader.classList.add('bg-warning', 'text-dark');
      } else if (tipo === 'danger') {
        toastHeader.classList.add('bg-danger', 'text-white');
      } else {
        toastHeader.classList.add('bg-info', 'text-white');
      }
    }

    // Mostrar toast
    const bsToast = new bootstrap.Toast(toastEl, { delay: 5000 });
    bsToast.show();
  } catch (error) {
    console.error('Error mostrando notificaci√≥n:', error);
  }
}
</script>

<!-- Scripts principales -->
<script src="js/auth-check.js?v=5"></script>
<script src="js/pos.js?v=16"></script>

<!-- ‚úÖ Manejo de cambio de rol (solo para manager) -->
<script>
function seleccionarRol(nuevoRol) {
    const usuario = JSON.parse(localStorage.getItem('user') || '{}');
    if (usuario.rol !== 'manager') {
        if (typeof window.mostrarNotificacion === 'function') {
            window.mostrarNotificacion('Acceso denegado', 'Solo el manager puede cambiar de rol.', 'warning');
        } else {
            alert('‚ö†Ô∏è Solo el manager puede cambiar de rol.');
        }
        return;
    }

    const rolesPermitidos = ['mesero', 'cajero', 'cocina', 'manager'];
    if (!rolesPermitidos.includes(nuevoRol)) {
        console.error('Rol no v√°lido:', nuevoRol);
        return;
    }

    usuario.rol = nuevoRol;
    localStorage.setItem('user', JSON.stringify(usuario));

    // Aplicar cambios sin recargar
    if (typeof window.aplicarPermisosPorRol === 'function') {
        window.aplicarPermisosPorRol(nuevoRol);
        if (typeof window.mostrarNotificacion === 'function') {
            window.mostrarNotificacion('√âxito', `Rol cambiado a: ${nuevoRol}`, 'success');
        }
    } else {
        location.reload();
    }
}
</script>

</body>
</html>
