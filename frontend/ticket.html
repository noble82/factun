<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="theme-color" content="#007bff">
    <title>Comprobante</title>
    <link rel="stylesheet" href="css/ticket.css">
</head>
<body>
    <div id="ticket-content" class="loading">
        Cargando comprobante...
    </div>

    <script>
        const API_BASE = '';

        async function cargarComprobante() {
            const params = new URLSearchParams(window.location.search);
            const pedidoId = params.get('pedido');

            if (!pedidoId) {
                document.getElementById('ticket-content').innerHTML = `
                    <div class="error">
                        <p>No se especificó el pedido</p>
                        <button class="btn-print btn-close" onclick="window.close()">Cerrar</button>
                    </div>
                `;
                return;
            }

            try {
                const response = await apiFetch(`${API_BASE}/api/pos/pedidos/${pedidoId}/comprobante`);

                if (!response.ok) {
                    throw new Error('Comprobante no encontrado');
                }

                const data = await response.json();
                renderComprobante(data);
            } catch (error) {
                document.getElementById('ticket-content').innerHTML = `
                    <div class="error">
                        <p>Error: ${error.message}</p>
                        <button class="btn-print btn-close" onclick="window.close()">Cerrar</button>
                    </div>
                `;
            }
        }

        function renderComprobante(data) {
            const { tipo, comprobante, codigo_generacion, numero_control } = data;

            if (tipo === 'ticket') {
                renderTicket(comprobante);
            } else {
                renderFactura(comprobante, codigo_generacion, numero_control);
            }
        }

        function renderTicket(ticket) {
            const itemsHtml = ticket.items.map(item => `
                <div class="item-row">
                    <div class="item-descripcion">${item.descripcion}</div>
                    <div class="item-detalle">
                        <span>${item.cantidad} x $${item.precio_unitario.toFixed(2)}</span>
                        <span>$${item.subtotal.toFixed(2)}</span>
                    </div>
                </div>
            `).join('');

            document.getElementById('ticket-content').innerHTML = `
                <div class="ticket-container">
                    <div class="ticket-header">
                        <div class="empresa-nombre">${ticket.empresa.nombre}</div>
                        <div class="empresa-info">
                            ${ticket.empresa.direccion}<br>
                            Tel: ${ticket.empresa.telefono}<br>
                            NIT: ${ticket.empresa.nit}
                        </div>
                    </div>

                    <div class="ticket-tipo">TICKET</div>

                    <div class="ticket-info">
                        <div><span>No:</span><span>${ticket.numero}</span></div>
                        <div><span>Fecha:</span><span>${ticket.fecha}</span></div>
                        <div><span>Hora:</span><span>${ticket.hora}</span></div>
                        <div><span>Mesa:</span><span>${ticket.mesa}</span></div>
                        ${ticket.mesero ? `<div><span>Atendió:</span><span>${ticket.mesero}</span></div>` : ''}
                    </div>

                    <div class="items-header">
                        <span>DESCRIPCIÓN</span>
                        <span>TOTAL</span>
                    </div>

                    ${itemsHtml}

                    <div class="totales">
                        <div><span>Subtotal:</span><span>$${ticket.subtotal.toFixed(2)}</span></div>
                        <div><span>IVA (13%):</span><span>$${ticket.iva.toFixed(2)}</span></div>
                        <div class="total-final"><span>TOTAL:</span><span>$${ticket.total.toFixed(2)}</span></div>
                    </div>

                    <div class="ticket-footer">
                        <div>*** DOCUMENTO NO FISCAL ***</div>
                        <div class="mensaje-footer">¡Gracias por su visita!</div>
                    </div>
                </div>

                <div class="no-print">
                    <button class="btn-print" onclick="window.print()">Imprimir</button>
                    <button class="btn-print btn-close" onclick="window.close()">Cerrar</button>
                </div>
            `;
        }

        function renderFactura(dte, codigoGeneracion, numeroControl) {
            const emisor = dte.emisor;
            const receptor = dte.receptor;
            const identificacion = dte.identificacion;
            const resumen = dte.resumen;
            const items = dte.cuerpoDocumento;

            const itemsHtml = items.map(item => `
                <div class="item-row">
                    <div class="item-descripcion">${item.descripcion}</div>
                    <div class="item-detalle">
                        <span>${item.cantidad} x $${item.precioUni.toFixed(2)}</span>
                        <span>$${item.ventaGravada.toFixed(2)}</span>
                    </div>
                </div>
            `).join('');

            const clienteHtml = receptor.nombre && receptor.nombre !== 'Consumidor Final' ? `
                <div class="cliente-info">
                    <div><strong>Cliente:</strong> ${receptor.nombre}</div>
                    ${receptor.numDocumento ? `<div>Doc: ${receptor.numDocumento}</div>` : ''}
                    ${receptor.direccion ? `<div>${receptor.direccion.complemento || ''}</div>` : ''}
                </div>
            ` : '';

            document.getElementById('ticket-content').innerHTML = `
                <div class="ticket-container">
                    <div class="ticket-header">
                        <div class="empresa-nombre">${emisor.nombreComercial || emisor.nombre}</div>
                        <div class="empresa-info">
                            ${emisor.direccion.complemento}<br>
                            Tel: ${emisor.telefono}<br>
                            NIT: ${emisor.nit} | NRC: ${emisor.nrc}
                        </div>
                    </div>

                    <div class="ticket-tipo">FACTURA ELECTRÓNICA</div>

                    <div class="ticket-info">
                        <div><span>No. Control:</span><span style="font-size:8px">${numeroControl}</span></div>
                        <div><span>Fecha:</span><span>${identificacion.fecEmi}</span></div>
                        <div><span>Hora:</span><span>${identificacion.horEmi}</span></div>
                    </div>

                    ${clienteHtml}

                    <div class="items-header">
                        <span>DESCRIPCIÓN</span>
                        <span>TOTAL</span>
                    </div>

                    ${itemsHtml}

                    <div class="totales">
                        <div><span>Subtotal:</span><span>$${resumen.subTotal.toFixed(2)}</span></div>
                        <div><span>IVA (13%):</span><span>$${resumen.totalIva.toFixed(2)}</span></div>
                        <div class="total-final"><span>TOTAL:</span><span>$${resumen.totalPagar.toFixed(2)}</span></div>
                        <div class="total-letras">${resumen.totalLetras}</div>
                    </div>

                    <div class="dte-info">
                        <div><strong>Código de Generación:</strong></div>
                        <div class="codigo">${codigoGeneracion}</div>
                        <div>Ambiente: ${identificacion.ambiente === '00' ? 'PRUEBAS' : 'PRODUCCIÓN'}</div>
                    </div>

                    <div class="ticket-footer">
                        <div>DTE - Documento Tributario Electrónico</div>
                        <div class="mensaje-footer">¡Gracias por su compra!</div>
                    </div>
                </div>

                <div class="no-print">
                    <button class="btn-print" onclick="window.print()">Imprimir</button>
                    <button class="btn-print btn-close" onclick="window.close()">Cerrar</button>
                </div>
            `;
        }

        // Cargar al iniciar
        cargarComprobante();
    </script>
</body>
</html>
