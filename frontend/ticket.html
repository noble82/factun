<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="theme-color" content="#007bff">
    <title>Comprobante</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #f5f5f5;
            padding: 20px;
        }

        .ticket-container {
            max-width: 300px;
            margin: 0 auto;
            background: white;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .ticket-header {
            text-align: center;
            border-bottom: 1px dashed #333;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .empresa-nombre {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .empresa-info {
            font-size: 10px;
            color: #666;
        }

        .ticket-tipo {
            font-size: 14px;
            font-weight: bold;
            margin: 10px 0;
            text-align: center;
            background: #333;
            color: white;
            padding: 5px;
        }

        .ticket-info {
            font-size: 11px;
            margin-bottom: 10px;
        }

        .ticket-info div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }

        .cliente-info {
            border-top: 1px dashed #333;
            border-bottom: 1px dashed #333;
            padding: 8px 0;
            margin: 10px 0;
            font-size: 11px;
        }

        .items-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-bottom: 5px;
        }

        .item-row {
            font-size: 11px;
            margin-bottom: 8px;
        }

        .item-descripcion {
            margin-bottom: 2px;
        }

        .item-detalle {
            display: flex;
            justify-content: space-between;
            color: #666;
            font-size: 10px;
        }

        .totales {
            border-top: 1px dashed #333;
            margin-top: 10px;
            padding-top: 10px;
            font-size: 11px;
        }

        .totales div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }

        .total-final {
            font-size: 14px;
            font-weight: bold;
            border-top: 2px solid #333;
            margin-top: 5px;
            padding-top: 5px;
        }

        .total-letras {
            font-size: 9px;
            font-style: italic;
            margin-top: 5px;
            text-align: center;
        }

        .dte-info {
            border-top: 1px dashed #333;
            margin-top: 10px;
            padding-top: 10px;
            font-size: 9px;
            text-align: center;
        }

        .dte-info .codigo {
            font-family: monospace;
            font-size: 8px;
            word-break: break-all;
            margin: 5px 0;
        }

        .ticket-footer {
            border-top: 1px dashed #333;
            margin-top: 10px;
            padding-top: 10px;
            text-align: center;
            font-size: 10px;
        }

        .mensaje-footer {
            margin-top: 10px;
            font-style: italic;
        }

        .no-print {
            text-align: center;
            margin: 20px 0;
        }

        .btn-print {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 30px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px;
        }

        .btn-print:hover {
            background: #0056b3;
        }

        .btn-close {
            background: #6c757d;
        }

        .btn-close:hover {
            background: #545b62;
        }

        /* Mobile responsive improvements */
        @media (max-width: 576px) {
            body {
                padding: 10px;
            }
            .ticket-container {
                max-width: 100%;
                padding: 12px;
            }
            .no-print {
                display: flex;
                flex-direction: column;
                gap: 10px;
                padding: 0 10px;
            }
            .btn-print {
                min-height: 48px;
                font-size: 16px;
                width: 100%;
                margin: 0;
                -webkit-tap-highlight-color: transparent;
            }
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .ticket-container {
                box-shadow: none;
                max-width: 80mm;
            }

            .no-print {
                display: none;
            }
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 50px;
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div id="ticket-content" class="loading">
        Cargando comprobante...
    </div>

    <script>
        const API_BASE = '';

        async function cargarComprobante() {
            const params = new URLSearchParams(window.location.search);
            const pedidoId = params.get('pedido');

            if (!pedidoId) {
                document.getElementById('ticket-content').innerHTML = `
                    <div class="error">
                        <p>No se especificó el pedido</p>
                        <button class="btn-print btn-close" onclick="window.close()">Cerrar</button>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/pos/pedidos/${pedidoId}/comprobante`);

                if (!response.ok) {
                    throw new Error('Comprobante no encontrado');
                }

                const data = await response.json();
                renderComprobante(data);
            } catch (error) {
                document.getElementById('ticket-content').innerHTML = `
                    <div class="error">
                        <p>Error: ${error.message}</p>
                        <button class="btn-print btn-close" onclick="window.close()">Cerrar</button>
                    </div>
                `;
            }
        }

        function renderComprobante(data) {
            const { tipo, comprobante, codigo_generacion, numero_control } = data;

            if (tipo === 'ticket') {
                renderTicket(comprobante);
            } else {
                renderFactura(comprobante, codigo_generacion, numero_control);
            }
        }

        function renderTicket(ticket) {
            const itemsHtml = ticket.items.map(item => `
                <div class="item-row">
                    <div class="item-descripcion">${item.descripcion}</div>
                    <div class="item-detalle">
                        <span>${item.cantidad} x $${item.precio_unitario.toFixed(2)}</span>
                        <span>$${item.subtotal.toFixed(2)}</span>
                    </div>
                </div>
            `).join('');

            document.getElementById('ticket-content').innerHTML = `
                <div class="ticket-container">
                    <div class="ticket-header">
                        <div class="empresa-nombre">${ticket.empresa.nombre}</div>
                        <div class="empresa-info">
                            ${ticket.empresa.direccion}<br>
                            Tel: ${ticket.empresa.telefono}<br>
                            NIT: ${ticket.empresa.nit}
                        </div>
                    </div>

                    <div class="ticket-tipo">TICKET</div>

                    <div class="ticket-info">
                        <div><span>No:</span><span>${ticket.numero}</span></div>
                        <div><span>Fecha:</span><span>${ticket.fecha}</span></div>
                        <div><span>Hora:</span><span>${ticket.hora}</span></div>
                        <div><span>Mesa:</span><span>${ticket.mesa}</span></div>
                        ${ticket.mesero ? `<div><span>Atendió:</span><span>${ticket.mesero}</span></div>` : ''}
                    </div>

                    <div class="items-header">
                        <span>DESCRIPCIÓN</span>
                        <span>TOTAL</span>
                    </div>

                    ${itemsHtml}

                    <div class="totales">
                        <div><span>Subtotal:</span><span>$${ticket.subtotal.toFixed(2)}</span></div>
                        <div><span>IVA (13%):</span><span>$${ticket.iva.toFixed(2)}</span></div>
                        <div class="total-final"><span>TOTAL:</span><span>$${ticket.total.toFixed(2)}</span></div>
                    </div>

                    <div class="ticket-footer">
                        <div>*** DOCUMENTO NO FISCAL ***</div>
                        <div class="mensaje-footer">¡Gracias por su visita!</div>
                    </div>
                </div>

                <div class="no-print">
                    <button class="btn-print" onclick="window.print()">Imprimir</button>
                    <button class="btn-print btn-close" onclick="window.close()">Cerrar</button>
                </div>
            `;
        }

        function renderFactura(dte, codigoGeneracion, numeroControl) {
            const emisor = dte.emisor;
            const receptor = dte.receptor;
            const identificacion = dte.identificacion;
            const resumen = dte.resumen;
            const items = dte.cuerpoDocumento;

            const itemsHtml = items.map(item => `
                <div class="item-row">
                    <div class="item-descripcion">${item.descripcion}</div>
                    <div class="item-detalle">
                        <span>${item.cantidad} x $${item.precioUni.toFixed(2)}</span>
                        <span>$${item.ventaGravada.toFixed(2)}</span>
                    </div>
                </div>
            `).join('');

            const clienteHtml = receptor.nombre && receptor.nombre !== 'Consumidor Final' ? `
                <div class="cliente-info">
                    <div><strong>Cliente:</strong> ${receptor.nombre}</div>
                    ${receptor.numDocumento ? `<div>Doc: ${receptor.numDocumento}</div>` : ''}
                    ${receptor.direccion ? `<div>${receptor.direccion.complemento || ''}</div>` : ''}
                </div>
            ` : '';

            document.getElementById('ticket-content').innerHTML = `
                <div class="ticket-container">
                    <div class="ticket-header">
                        <div class="empresa-nombre">${emisor.nombreComercial || emisor.nombre}</div>
                        <div class="empresa-info">
                            ${emisor.direccion.complemento}<br>
                            Tel: ${emisor.telefono}<br>
                            NIT: ${emisor.nit} | NRC: ${emisor.nrc}
                        </div>
                    </div>

                    <div class="ticket-tipo">FACTURA ELECTRÓNICA</div>

                    <div class="ticket-info">
                        <div><span>No. Control:</span><span style="font-size:8px">${numeroControl}</span></div>
                        <div><span>Fecha:</span><span>${identificacion.fecEmi}</span></div>
                        <div><span>Hora:</span><span>${identificacion.horEmi}</span></div>
                    </div>

                    ${clienteHtml}

                    <div class="items-header">
                        <span>DESCRIPCIÓN</span>
                        <span>TOTAL</span>
                    </div>

                    ${itemsHtml}

                    <div class="totales">
                        <div><span>Subtotal:</span><span>$${resumen.subTotal.toFixed(2)}</span></div>
                        <div><span>IVA (13%):</span><span>$${resumen.totalIva.toFixed(2)}</span></div>
                        <div class="total-final"><span>TOTAL:</span><span>$${resumen.totalPagar.toFixed(2)}</span></div>
                        <div class="total-letras">${resumen.totalLetras}</div>
                    </div>

                    <div class="dte-info">
                        <div><strong>Código de Generación:</strong></div>
                        <div class="codigo">${codigoGeneracion}</div>
                        <div>Ambiente: ${identificacion.ambiente === '00' ? 'PRUEBAS' : 'PRODUCCIÓN'}</div>
                    </div>

                    <div class="ticket-footer">
                        <div>DTE - Documento Tributario Electrónico</div>
                        <div class="mensaje-footer">¡Gracias por su compra!</div>
                    </div>
                </div>

                <div class="no-print">
                    <button class="btn-print" onclick="window.print()">Imprimir</button>
                    <button class="btn-print btn-close" onclick="window.close()">Cerrar</button>
                </div>
            `;
        }

        // Cargar al iniciar
        cargarComprobante();
    </script>
</body>
</html>
